# Game Database Completion TODO (Immediate)

This TODO tracks all remaining database tasks to reach fully working gameplay in production.

## World Databases (travian_testworld, travian_demo)

- [x] Create compatibility views (map legacy names used in code/docs to canonical T4.4 tables) ✅ COMPLETED
  - `villages` -> `vdata`
  - `alliances` -> `alidata`
  - `marketplace` -> `market`
  - SQL (run in both world DBs):
    ```sql
    USE travian_testworld;
    DROP VIEW IF EXISTS `villages`;
    CREATE VIEW `villages` AS SELECT * FROM `vdata`;
    DROP VIEW IF EXISTS `alliances`;
    CREATE VIEW `alliances` AS SELECT * FROM `alidata`;
    DROP VIEW IF EXISTS `marketplace`;
    CREATE VIEW `marketplace` AS SELECT * FROM `market`;

    USE travian_demo;
    DROP VIEW IF EXISTS `villages`;
    CREATE VIEW `villages` AS SELECT * FROM `vdata`;
    DROP VIEW IF EXISTS `alliances`;
    CREATE VIEW `alliances` AS SELECT * FROM `alidata`;
    DROP VIEW IF EXISTS `marketplace`;
    CREATE VIEW `marketplace` AS SELECT * FROM `market`;
    ```

- [x] Create `handshake` table in each world DB (required by FIX-03 login flow if not present) ✅ COMPLETED
  - SQL:
    ```sql
    USE travian_testworld;
    CREATE TABLE IF NOT EXISTS `handshake` (
      `id` INT(11) UNSIGNED NOT NULL AUTO_INCREMENT,
      `uid` INT(11) UNSIGNED NOT NULL,
      `handshake` VARCHAR(64) NOT NULL,
      `sitter` TINYINT(1) NOT NULL DEFAULT 0,
      `created_at` INT(10) UNSIGNED NOT NULL,
      PRIMARY KEY (`id`),
      UNIQUE KEY `handshake` (`handshake`),
      KEY `uid` (`uid`)
    ) ENGINE=InnoDB DEFAULT CHARSET=utf8mb4;

    USE travian_demo;
    CREATE TABLE IF NOT EXISTS `handshake` (
      `id` INT(11) UNSIGNED NOT NULL AUTO_INCREMENT,
      `uid` INT(11) UNSIGNED NOT NULL,
      `handshake` VARCHAR(64) NOT NULL,
      `sitter` TINYINT(1) NOT NULL DEFAULT 0,
      `created_at` INT(10) UNSIGNED NOT NULL,
      PRIMARY KEY (`id`),
      UNIQUE KEY `handshake` (`handshake`),
      KEY `uid` (`uid`)
    ) ENGINE=InnoDB DEFAULT CHARSET=utf8mb4;
    ```

- [x] Re-run connectivity verification ✅ COMPLETED
  - `docker exec travian-php php /var/www/html/test-world-connection.php`
  - Expect to see: users, villages, alliances, activation, marketplace "present"

## Global Database (travian_global)

The following tables were referenced historically in docs. Current DB contains many required tables (activation, gameServers, configurations, mailserver, passwordRecovery, email_blacklist, etc.).

- [ ] Validate actual need for `payment_log` (not present, no code references found)
  - Action: search code for usage and either:
    - Create table (if truly needed), or
    - Remove from docs as obsolete
  - Suggested DDL (if needed):
    ```sql
    CREATE TABLE IF NOT EXISTS `payment_log` (
      `id` INT UNSIGNED NOT NULL AUTO_INCREMENT,
      `uid` INT UNSIGNED NOT NULL,
      `provider` VARCHAR(32) NOT NULL,
      `txid` VARCHAR(64) NOT NULL,
      `amount` DECIMAL(10,2) NOT NULL,
      `currency` CHAR(3) NOT NULL DEFAULT 'USD',
      `status` VARCHAR(16) NOT NULL,
      `created_at` INT UNSIGNED NOT NULL,
      PRIMARY KEY (`id`),
      KEY `uid` (`uid`),
      UNIQUE KEY `uniq_txid` (`provider`,`txid`)
    ) ENGINE=InnoDB DEFAULT CHARSET=utf8mb4;
    ```

- [ ] Validate actual need for `voting` (not present, no direct code references; voting feature appears to use external callbacks and `voting_reward_queue` instead)
  - Action: confirm feature design; if still required, add minimal schema or update docs to reflect current approach.

- [x] Create placeholder tables for future features ✅ COMPLETED
  - `payment_log`, `voting` created via `scripts/create-global-misc-tables.sql`

- [ ] Confirm present global tables match code needs (sample present):
  - Present in DB: `activation`, `activation_progress`, `alidata`, `available_villages`, `banIP`, `email_blacklist`, `gameServers`, `login_handshake`, `mailserver`, `passwordRecovery`, `market`, `vdata`, `users`, etc.
  - Action: run a quick audit script to compare code queries to DB tables (separate task)

## Schema Audit (1:1 completeness)

- [x] Audit world DBs against T4.4 schema (base tables only) ✅ COMPLETED
  - Command:
    ```powershell
    .\scripts\audit-world-tables.ps1
    ```
  - Report: `reports/world-schema-audit.txt`

- [x] Audit global DB for presence of key tables ✅ COMPLETED
  - Command:
    ```powershell
    .\scripts\audit-global-tables.ps1
    ```
  - Report: `reports/global-schema-audit.txt`

## FIX-03 Flow Tests

- [ ] Run login test and verify redirect (activate.php or handshake login)
  - Command:
    ```powershell
    docker exec travian-php php /var/www/html/test-login.php
    ```
  - Expect: redirect URL in response

- [ ] Add/Run complete activation flow test (register → activation → login)
  - Create `test-complete-flow.php` (optional), or use existing tests in `_project/testing/`

## Automation

- [ ] Run `scripts/create-compat-views.ps1` to create world views automatically
- [ ] Keep this TODO updated if new missing tables or views are discovered

---

## Verification Checklist (DB readiness)

- [ ] World DBs each show 90+ tables
- [ ] Views exist: `villages`, `alliances`, `marketplace` (both DBs)
- [ ] World DBs contain `handshake` (both DBs)
- [ ] Registration test passes (activation row exists)
- [ ] Login test passes (redirect returned)
- [ ] No failing queries due to table name mismatches
